<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proma 3</title>
  </head>
  <body>
    <input type="text" placeholder="Your name" id="name" />
    <h2>Hello <span id="res">{name}</span></h2>
    <button type="button" id="button">Click me</button>
    <script type="module">
      import {
        chip,
        inputFlow,
        inputData,
        outputFlow,
        outputData,
        outputHandler,
        wire,
      } from './core/index.mjs';

      import { Start, Log, Literal } from './lib/index.mjs';

      const Random = chip('Random', () => {
        const exec = inputFlow('exec', () => {
          value(Math.random());
          then();
        });
        const then = outputFlow('then');
        const value = outputData('value');
      });

      const Pass = chip('Pass', () => {
        const exec = inputFlow('exec');
        const input = inputData('input');
        const then = outputFlow('then');
        const output = outputData('output', then);
        wire(exec, then);
        wire(input, output);
      });

      const Greet = chip('Greet', () => {
        const name = inputData('name', { canonical: true });
        const value = outputData('value', () => {
          let greet = 'Hello ';
          greet += name();
          return greet + '!';
        });
      });

      const Sum = chip('Sum', () => {
        const numbers = inputData('numbers', {
          variadic: '{letter}',
          canonical: true,
        });
        const value = outputData('value', () => {
          return numbers().reduce((acc, n) => acc + n, 0);
        });
      });

      const MyChip = chip('MyChip', () => {
        const exec = inputFlow('exec');
        const one = inputData('one', { defaultValue: 0, canonical: true });
        const two = inputData('two', { defaultValue: 0, canonical: true });

        const sum = new Sum();
        wire(one, sum.in.A);
        wire(two, sum.in.B);

        const log = new Log();
        wire(exec, log.in.exec);
        wire(sum.out.value, log.in.message);

        const then = outputFlow('then');
        wire(log.out.then, then);

        const res = outputData('res');
        wire(sum.out.value, res);
      });

      // window.chip = new MyChip();
      // console.log(window.chip);
      // window.chip.in.exec()

      // const c = MyChip();
      // const code = c.compile();
      // console.group('Code');
      // console.log(code);
      // console.groupEnd();
      // console.group('Code execution');
      // const func = new Function('return (' + code + ')');
      // window.Chip = func();
      // window.chip = new window.Chip();
      // console.groupEnd();

      //
      // Ideas
      //

      // const eventPlate = plate('event')
      // const bind = new Bind(self, 'click');
      // wire(eventPlate, bind.in.event)
      // wire(eventPlate.out.exec, log.in.exec);
      // wire(eventPlate.out.event, log.in.message);

      // const CustomEvent = chip(() => {
      //   const exec = inputFlow('exec');
      //   const event = inputData('event');
      // });

      // plates: no `in`, with `ref` -> `const p = plate('event')`
      // emitters: only one `in.plate` -> `const e = emitter((plate) => plate()())`
      // `wire(plate.out.ref, e.in.plate)`

      // Plate:
      // Could be just `handle` and provide both in and out?
      // const ref = outputHandle('ref', (e) => {
      //   event(e);
      //   then();
      // });
      // const then = outputFlow('then');
      // const event = outputData('event');

      // Using plate:
      // const exec = inputFlow('exec', () => {
      //   event()();
      // });
      // // or
      // // emitter(() => { event()() }); just a conceiled inputFlow with an `autoExec: true`?
      // const event = inputData('event');

      const Evt = chip('Evt', () => {
        const ref = outputHandler('ref', (e) => {
          event(e);
          then();
        });
        const then = outputFlow('then');
        const event = outputData('event');
      });

      const BindClick = chip('BindClick', () => {
        const exec = inputFlow('exec', () => {
          const t = document.getElementById(target());
          t.addEventListener('click', event());
          then();
        });
        const target = inputData('target', { canonical: true });
        const event = inputData('event');
        const then = outputFlow('then');
      });

      const MyChip2 = chip('MyChip2', () => {
        // const start = new Start();
        const exec = inputFlow('exec');
        const bind = new BindClick('button');
        const evt = new Evt();
        const log = new Log('clicked!');

        // wire(start.out.then, bind.in.exec);
        wire(exec, bind.in.exec);
        wire(evt.out.ref, bind.in.event);
        wire(evt.out.then, log.in.exec);
        wire(evt.out.event, log.in.message);
      });

      window.chip = new MyChip2();
      window.code = window.chip.compile();
      console.log(window.code);
      // const func = new Function('return (' + code + ')');
      // window.ChipCompiled = func();
      // window.chipComp = new window.ChipCompiled();
    </script>
  </body>
</html>
